@page "/"
@inject ProximityUiState State
@inject ISettingsService SettingsService
@inject ISnackbar Snackbar
@inject ProximitySensorReaderBackgroundService Reader
@implements IDisposable

<PageTitle>Dashboard</PageTitle>

<MudContainer Class="px-2 pt-2" Style="padding-top: 0;">

    <MudText Class="mb-2" Typo="Typo.h4">Sensors</MudText>

    <MudGrid Class="mb-4">
        @foreach (var sensor in Enum.GetValues<Sensor>())
        {
            var sensorCached = sensor;
            if (sensorCached == Sensor.None) continue;
            <MudItem xs="12" sm="6" md="4">
                <MudCard Outlined="true">
                    <MudCardContent>
                        <MudText Typo="Typo.h5" Color="Color.Primary">@sensorCached.ToString()</MudText>
                        @if (State.LastSensorEventMap[sensor] != null)
                        {
                            <MudText Typo="Typo.body1">Value: <strong>@State.LastSensorEventMap[sensorCached]?.Value</strong></MudText>
                            <MudText Typo="Typo.body1">Timestamp: <strong>@State.LastSensorEventMap[sensorCached]?.Timestamp.ToString("HH:mm:ss")</strong></MudText>
                        }
                        else
                        {
                            <MudSkeleton />
                            <MudSkeleton />
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   Size="Size.Small"
                                   OnClick="() => SimulateSensor(sensorCached)"
                                   StartIcon="@Icons.Material.Filled.PlayArrow">
                            Trigger
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    <MudText Class="mb-2" Typo="Typo.h4">Settings</MudText>

    <MudForm @ref="form">
        <MudGrid>
            <MudItem xs="12">
                <MudPaper Class="pa-4" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Timing Settings</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="SmoothDuration"
                                             Label="Smooth Duration"
                                             Variant="Variant.Outlined"
                                             Min="100"
                                             Max="10_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="HoldDuration"
                                             Label="Hold Duration"
                                             Variant="Variant.Outlined"
                                             Min="1_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="SensorDelay"
                                             Label="Sensor Delay"
                                             Variant="Variant.Outlined"
                                             Min="100"
                                             Max="10_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-4" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Brightness Settings</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="Steps"
                                             Label="Steps"
                                             Variant="Variant.Outlined"
                                             Min="1"
                                             Max="20" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="MaxBrightness"
                                             Label="Max Brightness"
                                             Variant="Variant.Outlined"
                                             Min="1"
                                             Max="100"
                                             Adornment="Adornment.End"
                                             AdornmentText="%" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="MinBrightness"
                                             Label="Min Brightness"
                                             Variant="Variant.Outlined"
                                             Min="0"
                                             Max="100"
                                             Adornment="Adornment.End"
                                             AdornmentText="%" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="ProximityEventTreshold"
                                             Label="Proximity Threshold"
                                             Variant="Variant.Outlined"
                                             Min="2_500"
                                             Max="70_000" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-4" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Section Configuration</MudText>
                    <MudGrid>

                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="int" Label="Section 1" MultiSelection="true" @bind-SelectedValues="Section1" Variant="Variant.Outlined">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="int" Label="Section 2" MultiSelection="true" @bind-SelectedValues="Section2" Variant="Variant.Outlined">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="int" Label="Section 3 (Sensor 3)" MultiSelection="true" @bind-SelectedValues="Section3" Variant="Variant.Outlined" Disabled="@(!EnableSection3)">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                            <MudSwitch @bind-Value="EnableSection3"
                                       Color="Color.Primary"
                                       Label="Enable Section 3"
                                       Class="mt-2" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="int" Label="Section 4 (Sensor 4)" MultiSelection="true" @bind-SelectedValues="Section4" Variant="Variant.Outlined" Disabled="@(!EnableSection4)">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                            <MudSwitch @bind-Value="EnableSection4"
                                       Color="Color.Primary"
                                       Label="Enable Section 4"
                                       Class="mt-2" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="int" Label="Section 5 (Sensor 5)" MultiSelection="true" @bind-SelectedValues="Section5" Variant="Variant.Outlined" Disabled="@(!EnableSection5)">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                            <MudSwitch @bind-Value="EnableSection5"
                                       Color="Color.Primary"
                                       Label="Enable Section 5"
                                       Class="mt-2" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mb-4">
            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-4 d-flex justify-content-center" Outlined="true">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               DisableElevation="true"
                               OnClick="SaveSettings"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Save">
                        Save Settings
                    </MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudForm>

    <MudText Class="mb-2" Typo="Typo.h4">Data</MudText>

    <MudPaper Class="doc-section-component-container pa-4 mb-4" Outlined="true">
        <MudText Typo="Typo.h5">Total Events</MudText>
        <MudChart ChartType="ChartType.StackedBar" ChartSeries="@State.BarChartSeries" XAxisLabels="@State.BarChartXAxisLabels"></MudChart>
    </MudPaper>

    <MudPaper Class="doc-section-component-container pa-4" Outlined="true">
        <MudText Typo="Typo.h5">Proximity Timestamp</MudText>
        <MudTimeSeriesChart ChartSeries="@State.Series"
                            CanHideSeries="true"
                            TimeLabelSpacing="@State.TimeLabelSpacing"
                            DataMarkerTooltipTimeLabelFormat="HH:mm:ss" />
    </MudPaper>
</MudContainer>



@code {
    MudForm form = default!;
    private int SmoothDuration { get; set; }
    private int HoldDuration { get; set; }
    private int SensorDelay { get; set; }
    private int Steps { get; set; }
    private int MaxBrightness { get; set; }
    private int MinBrightness { get; set; }
    private int ProximityEventTreshold { get; set; }

    private readonly int[] _segments = Enumerable.Range(0, 15).ToArray();
    private IEnumerable<int> Section1 { get; set; } = new HashSet<int>();
    private IEnumerable<int> Section2 { get; set; } = new HashSet<int>();
    private IEnumerable<int> Section3 { get; set; } = new HashSet<int>();
    private IEnumerable<int> Section4 { get; set; } = new HashSet<int>();
    private IEnumerable<int> Section5 { get; set; } = new HashSet<int>();
    private bool EnableSection3 { get; set; }
    private bool EnableSection4 { get; set; }
    private bool EnableSection5 { get; set; }

    protected override void OnInitialized()
    {
        LoadSettings();
        State.OnChange += OnStateChanged;
        SettingsService.SettingsChanged += OnSettingsChanged;
    }

    private void LoadSettings()
    {
        var settings = SettingsService.GetSettings();
        SmoothDuration = (int)settings.SmoothDuration.TotalMilliseconds;
        HoldDuration = (int)settings.HoldDuration.TotalMilliseconds;
        SensorDelay = (int)settings.SensorDelay.TotalMilliseconds;
        Steps = settings.Steps;
        MaxBrightness = settings.MaxBrightness;
        MinBrightness = settings.MinBrightness;
        ProximityEventTreshold = settings.ProximityEventTreshold;

        Section1 = settings.Section1.ToHashSet();
        Section2 = settings.Section2.ToHashSet();
        Section3 = settings.Section3.ToHashSet();
        Section4 = settings.Section4.ToHashSet();
        Section5 = settings.Section5.ToHashSet();

        EnableSection3 = settings.Section3 != null && settings.Section3.Count > 0;
        EnableSection4 = settings.Section4 != null && settings.Section4.Count > 0;
        EnableSection5 = settings.Section5 != null && settings.Section5.Count > 0;
    }

    private async void OnStateChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void OnSettingsChanged(object? sender, EventArgs e)
    {
        LoadSettings();
        await InvokeAsync(StateHasChanged);
    }

    private void SimulateSensor(Sensor sensor)
    {
        var settings = SettingsService.GetSettings();
        var rnd = Random.Shared.Next(55_000);
        var simulatedEvent = new ProximityEvent(sensor, settings.ProximityEventTreshold + rnd, DateTime.Now);

        State.Update(simulatedEvent);
        Snackbar.Add($"Simulated {sensor} trigger!", Severity.Info);
    }

    private async Task SaveSettings()
    {
        await form.Validate();

        if (form.IsValid)
        {
            try
            {
                SettingsService.UpdateSettings(settings =>
                {
                    settings.SmoothDuration = TimeSpan.FromMilliseconds(SmoothDuration);
                    settings.HoldDuration = TimeSpan.FromMilliseconds(HoldDuration);
                    settings.SensorDelay = TimeSpan.FromMilliseconds(SensorDelay);
                    settings.Steps = Steps;
                    settings.MaxBrightness = MaxBrightness;
                    settings.MinBrightness = MinBrightness;
                    settings.ProximityEventTreshold = ProximityEventTreshold;
                    settings.Section1 = Section1.ToList();
                    settings.Section2 = Section2.ToList();
                    settings.Section3 = Section3.ToList();
                    settings.Section4 = Section4.ToList();
                    settings.Section5 = Section5.ToList();
                });

                Snackbar.Add("Settings saved successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error parsing sections: {ex.Message}", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("Please fix validation errors", Severity.Error);
        }
    }

    public void Dispose()
    {
        State.OnChange -= OnStateChanged;
        SettingsService.SettingsChanged -= OnSettingsChanged;
    }
}