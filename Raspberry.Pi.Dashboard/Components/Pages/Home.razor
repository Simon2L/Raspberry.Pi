@page "/"
@inject ProximityUiState State
@inject ISettingsService SettingsService
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Dashboard</PageTitle>

<MudContainer Class="px-4 pt-2" Style="padding-top: 0;">
    <MudText Typo="Typo.h3" GutterBottom="true">Dashboard</MudText>

    <MudGrid Class="mb-2">
        <MudItem xs="12" sm="6">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h6" Color="Color.Primary">Sensor 1</MudText>
                    <MudText Typo="Typo.body1">
                        Value: <strong>@State.LastEventSensor1?.Value</strong>
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@State.LastEventSensor1?.Timestamp.ToString("HH:mm:ss")</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h6" Color="Color.Primary">Sensor 2</MudText>
                    <MudText Typo="Typo.body1">
                        Value: <strong>@State.LastEventSensor2?.Value</strong>
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@State.LastEventSensor2?.Timestamp.ToString("HH:mm:ss")</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudForm @ref="form">
        <MudGrid>
            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-2" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Timing Settings</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="SmoothDuration"
                                             Label="Smooth Duration"
                                             Variant="Variant.Outlined"
                                             Min="100"
                                             Max="10_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="HoldDuration"
                                             Label="Hold Duration"
                                             Variant="Variant.Outlined"
                                             Min="1_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="SensorDelay"
                                             Label="Sensor Delay"
                                             Variant="Variant.Outlined"
                                             Min="100"
                                             Max="10_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-2" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Brightness Settings</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="Steps"
                                             Label="Steps"
                                             Variant="Variant.Outlined"
                                             Min="1"
                                             Max="20" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="MaxBrightness"
                                             Label="Max Brightness"
                                             Variant="Variant.Outlined"
                                             Min="1"
                                             Max="100"
                                             Adornment="Adornment.End"
                                             AdornmentText="%" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="MinBrightness"
                                             Label="Min Brightness"
                                             Variant="Variant.Outlined"
                                             Min="0"
                                             Max="100"
                                             Adornment="Adornment.End"
                                             AdornmentText="%" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="ProximityEventTreshold"
                                             Label="Proximity Threshold"
                                             Variant="Variant.Outlined"
                                             Min="2_500"
                                             Max="70_000" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-2" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Section Configuration</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Section1Text"
                                          Label="Section 1 (comma-separated)"
                                          Variant="Variant.Outlined"
                                          Placeholder="1, 2, 3, 4, 5, 6"
                                          HelperText="Enter pin numbers separated by commas" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Section2Text"
                                          Label="Section 2 (comma-separated)"
                                          Variant="Variant.Outlined"
                                          Placeholder="8, 9, 10, 11, 12, 13, 14"
                                          HelperText="Enter pin numbers separated by commas" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-2">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               DisableElevation="true"
                               OnClick="SaveSettings"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Save">
                        Save Settings
                    </MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudForm>
</MudContainer>

@code {
    MudForm form = default!;
    private int SmoothDuration { get; set; }
    private int HoldDuration { get; set; }
    private int SensorDelay { get; set; }
    private int Steps { get; set; }
    private int MaxBrightness { get; set; }
    private int MinBrightness { get; set; }
    private int ProximityEventTreshold { get; set; }
    private string Section1Text { get; set; } = string.Empty;
    private string Section2Text { get; set; } = string.Empty;

    protected override void OnInitialized()
    {
        LoadSettings();
        State.OnChange += OnStateChanged;
        SettingsService.SettingsChanged += OnSettingsChanged;
    }

    private void LoadSettings()
    {
        var settings = SettingsService.GetSettings();
        SmoothDuration = (int)settings.SmoothDuration.TotalMilliseconds;
        HoldDuration = (int)settings.HoldDuration.TotalMilliseconds;
        SensorDelay = (int)settings.SensorDelay.TotalMilliseconds;
        Steps = settings.Steps;
        MaxBrightness = settings.MaxBrightness;
        MinBrightness = settings.MinBrightness;
        ProximityEventTreshold = settings.ProximityEventTreshold;
        Section1Text = string.Join(", ", settings.Section1);
        Section2Text = string.Join(", ", settings.Section2);
    }

    private async void OnStateChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void OnSettingsChanged(object? sender, EventArgs e)
    {
        LoadSettings();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveSettings()
    {
        await form.Validate();

        if (form.IsValid)
        {
            try
            {
                var section1 = ParseIntList(Section1Text);
                var section2 = ParseIntList(Section2Text);

                SettingsService.UpdateSettings(settings =>
                {
                    settings.SmoothDuration = TimeSpan.FromMilliseconds(SmoothDuration);
                    settings.HoldDuration = TimeSpan.FromMilliseconds(HoldDuration);
                    settings.SensorDelay = TimeSpan.FromMilliseconds(SensorDelay);
                    settings.Steps = Steps;
                    settings.MaxBrightness = MaxBrightness;
                    settings.MinBrightness = MinBrightness;
                    settings.ProximityEventTreshold = ProximityEventTreshold;
                    settings.Section1 = section1;
                    settings.Section2 = section2;
                });

                Snackbar.Add("Settings saved successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error parsing sections: {ex.Message}", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("Please fix validation errors", Severity.Error);
        }
    }

    private void ResetSettings()
    {
        LoadSettings();
        Snackbar.Add("Settings reset to current values", Severity.Info);
    }

    private List<int> ParseIntList(string input)
    {
        return input.Split(',')
            .Select(s => s.Trim())
            .Where(s => !string.IsNullOrEmpty(s))
            .Select(int.Parse)
            .ToList();
    }

    public void Dispose()
    {
        State.OnChange -= OnStateChanged;
        SettingsService.SettingsChanged -= OnSettingsChanged;
    }
}