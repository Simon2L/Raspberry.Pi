@page "/colorduko"
@inject ISnackbar Snackbar

<PageTitle>Colorduko</PageTitle>

<MudCard>
    <MudCardContent Class="d-flex justify-content-center">
        <MudGrid Spacing="1">
            @for (int row = 0; row < board.GetLength(0); row++)
            {
                @for (int col = 0; col < board.GetLength(1); col++)
                {
                    var cellValue = board[col, row];
                    int rowIndex = row;
                    int colIndex = col;
                    <MudItem>
                        <MudMenu Color="ToColor(cellValue.Color)" Label="@cellValue.Color.ToString()" Style="height: 90px; width: 90px">
                            @if (cellValue.IsFixed)
                            {
                                <MudMenuItem Disabled="true">Fixed</MudMenuItem>
                            }
                            else
                            {
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Red)">Red</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Blue)">Blue</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Green)">Green</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Yellow)">Yellow</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Purple)">Purple</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Orange)">Orange</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Cyan)">Cyan</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Magenta)">Magenta</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.Lime)">Lime</MudMenuItem>
                                <MudMenuItem OnClick="() => HandleColorChange(colIndex, rowIndex, ColorDukoColors.None)">Clear</MudMenuItem>
                            }
                        </MudMenu>
                    </MudItem>
                    if (col % 8 == 0 && col != 0)
                    {
                        <MudDivider />
                    }
                }
            }

        </MudGrid>
    </MudCardContent>
</MudCard>

@code {
    private Cell[,] board = new Cell[9, 9];

    private void InitializeBoard()
    {
        for (int row = 0; row < board.GetLength(0); row++)
        {
            for (int col = 0; col < board.GetLength(1); col++)
            {
                board[col, row] = new(ColorDukoColors.None, false);
            }
        }
        board[0, 0] = new(ColorDukoColors.Red, true);
        board[1, 1] = new(ColorDukoColors.Blue, true);
        board[3, 4] = new(ColorDukoColors.Green, true);
        board[8, 8] = new(ColorDukoColors.Yellow, true);
        board[6, 2] = new(ColorDukoColors.Purple, true);
    }

    protected override void OnInitialized()
    {
        InitializeBoard();
    }

    private void HandleColorChange(int col, int row, ColorDukoColors color)
    {
        if (color == ColorDukoColors.None)
        {
            SetColor(col, row, ColorDukoColors.None);
            return;
        }

        var valid = IsValidMove(col, row, color);
        if (!valid)
        {
            Snackbar.Add("Invalid move!", Severity.Error);
            return;
        }
        SetColor(col, row, color);
    }

    private void SetColor(int col, int row, ColorDukoColors color)
    {
        board[col, row].Color = color;
    }

    private bool IsValidMove(int col, int row, ColorDukoColors color)
    {
        return CheckColumn(col, color) && CheckRow(row, color) && CheckBox(col, row, color);
    }

    private bool CheckRow(int row, ColorDukoColors color)
    {
        for (int col = 0; col < board.GetLength(1); col++)
        {
            if (board[col, row].Color == color)
            {
                return false;
            }
        }
        return true;
    }

    private bool CheckColumn(int col, ColorDukoColors color)
    {
        for (int row = 0; row < board.GetLength(0); row++)
        {
            if (board[col, row].Color == color)
            {
                return false;
            }
        }
        return true;
    }

    private bool CheckBox(int col, int row, ColorDukoColors color)
    {
        int startRow = (int)Math.Floor(row / 3.0) * 3;
        int startCol = (int)Math.Floor(col / 3.0) * 3;

        for (int r = startRow; r < (startRow + 3); r++)
        {
            for (int c = startCol; c < (startCol + 3); c++)
            {
                if (r == row && c == col) continue;
                if (board[c, r].Color == color) return false;

            }
        }
        return true;
    }

    private Color ToColor(ColorDukoColors dukoColors)
    {
        return dukoColors switch
        {
            ColorDukoColors.Red => Color.Surface,
            ColorDukoColors.Blue => Color.Primary,
            ColorDukoColors.Green => Color.Secondary,
            ColorDukoColors.Yellow => Color.Tertiary,
            ColorDukoColors.Purple => Color.Info,
            ColorDukoColors.Orange => Color.Warning,
            ColorDukoColors.Cyan => Color.Error,
            ColorDukoColors.Magenta => Color.Success,
            ColorDukoColors.Lime => Color.Dark,
            _ => Color.Default
        };
    }

    private class Cell(ColorDukoColors color, bool isFixed)
    {
        public bool IsFixed { get; } = isFixed;
        public ColorDukoColors Color { get; set; } = color;
    }
}
