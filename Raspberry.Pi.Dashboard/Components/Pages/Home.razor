@page "/"
@inject ProximityUiState State
@inject ISettingsService SettingsService
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Dashboard</PageTitle>

<MudContainer Class="px-4 pt-2" Style="padding-top: 0;">
    <MudText Typo="Typo.h3" GutterBottom="true">Dashboard</MudText>

    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6">
            <MudCard Outlined="true">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Color="Color.Primary">Sensor 1</MudText>
                    @if (State.LastEventSensor1 != null)
                    {
                        <MudText Typo="Typo.body1">
                            Value: <strong>@State.LastEventSensor1?.Value</strong>
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Timestamp: @State.LastEventSensor1?.Timestamp.ToString("HH:mm:ss")</MudText>
                    }
                    else
                    {
                        <MudSkeleton />
                        <MudSkeleton />
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudCard Outlined="true">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Color="Color.Primary">Sensor 2</MudText>
                    @if (State.LastEventSensor2 != null)
                    {
                        <MudText Typo="Typo.body1">
                            Value: <strong>@State.LastEventSensor2?.Value</strong>
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Timestamp: @State.LastEventSensor2?.Timestamp.ToString("HH:mm:ss")</MudText>
                    }
                    else
                    {
                        <MudSkeleton />
                        <MudSkeleton />
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudCard Outlined="true">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Color="Color.Primary">Sensor 3</MudText>
                    @if (State.LastEventSensor3 != null)
                    {
                        <MudText Typo="Typo.body1">
                            Value: <strong>@State.LastEventSensor3?.Value</strong>
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Timestamp: @State.LastEventSensor3?.Timestamp.ToString("HH:mm:ss")</MudText>
                    }
                    else
                    {
                        <MudSkeleton />
                        <MudSkeleton />
                    }
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               Size="Size.Small"
                               OnClick="() => SimulateSensor(Sensor.Sensor3)"
                               StartIcon="@Icons.Material.Filled.PlayArrow">
                        Trigger
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="4">
            <MudCard Outlined="true">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Color="Color.Primary">Sensor 4</MudText>
                    @if (State.LastEventSensor4 != null)
                    {
                        <MudText Typo="Typo.body1">
                            Value: <strong>@State.LastEventSensor4?.Value</strong>
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Timestamp: @State.LastEventSensor4?.Timestamp.ToString("HH:mm:ss")</MudText>
                    }
                    else
                    {
                        <MudSkeleton />
                        <MudSkeleton />
                    }
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               Size="Size.Small"
                               OnClick="() => SimulateSensor(Sensor.Sensor4)"
                               StartIcon="@Icons.Material.Filled.PlayArrow">
                        Trigger
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="4">
            <MudCard Outlined="true">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Color="Color.Primary">Sensor 5</MudText>
                    @if (State.LastEventSensor5 != null)
                    {
                        <MudText Typo="Typo.body1">
                            Value: <strong>@State.LastEventSensor5?.Value</strong>
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Timestamp: @State.LastEventSensor5?.Timestamp.ToString("HH:mm:ss")</MudText>
                    }
                    else
                    {
                        <MudSkeleton />
                        <MudSkeleton />
                    }
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               Size="Size.Small"
                               OnClick="() => SimulateSensor(Sensor.Sensor5)"
                               StartIcon="@Icons.Material.Filled.PlayArrow">
                        Trigger
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudForm @ref="form">
        <MudGrid>
            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-2" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Timing Settings</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="SmoothDuration"
                                             Label="Smooth Duration"
                                             Variant="Variant.Outlined"
                                             Min="100"
                                             Max="10_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="HoldDuration"
                                             Label="Hold Duration"
                                             Variant="Variant.Outlined"
                                             Min="1_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="4">
                            <MudNumericField @bind-Value="SensorDelay"
                                             Label="Sensor Delay"
                                             Variant="Variant.Outlined"
                                             Min="100"
                                             Max="10_000"
                                             Adornment="Adornment.End"
                                             AdornmentText="ms" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-2" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Brightness Settings</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="Steps"
                                             Label="Steps"
                                             Variant="Variant.Outlined"
                                             Min="1"
                                             Max="20" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="MaxBrightness"
                                             Label="Max Brightness"
                                             Variant="Variant.Outlined"
                                             Min="1"
                                             Max="100"
                                             Adornment="Adornment.End"
                                             AdornmentText="%" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="MinBrightness"
                                             Label="Min Brightness"
                                             Variant="Variant.Outlined"
                                             Min="0"
                                             Max="100"
                                             Adornment="Adornment.End"
                                             AdornmentText="%" />
                        </MudItem>

                        <MudItem xs="12" sm="6" md="3">
                            <MudNumericField @bind-Value="ProximityEventTreshold"
                                             Label="Proximity Threshold"
                                             Variant="Variant.Outlined"
                                             Min="2_500"
                                             Max="70_000" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-2" Outlined="true">
                    <MudText Typo="Typo.h5" Class="mb-4">Section Configuration</MudText>
                    <MudGrid>

                        <MudItem xs="12" sm="6">
                            <MudSelect T="int" Label="Section 1" MultiSelection="true" @bind-SelectedValues="Section1" Variant="Variant.Outlined">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudSelect T="int" Label="Section 2" MultiSelection="true" @bind-SelectedValues="Section2" Variant="Variant.Outlined">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="int" Label="Section 3 (Sensor 3)" MultiSelection="true" @bind-SelectedValues="Section3" Variant="Variant.Outlined" Disabled="@(!EnableSection3)">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                            <MudSwitch @bind-Value="EnableSection3"
                                       Color="Color.Primary"
                                       Label="Enable Section 3"
                                       Class="mt-2" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudSelect T="int" Label="Section 4 (Sensor 4)" MultiSelection="true" @bind-SelectedValues="Section4" Variant="Variant.Outlined" Disabled="@(!EnableSection4)">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                            <MudSwitch @bind-Value="EnableSection4"
                                       Color="Color.Primary"
                                       Label="Enable Section 4"
                                       Class="mt-2" />
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudSelect T="int" Label="Section 5 (Sensor 5)" MultiSelection="true" @bind-SelectedValues="Section5" Variant="Variant.Outlined" Disabled="@(!EnableSection5)">
                                @foreach (var segment in _segments)
                                {
                                    <MudSelectItem T="int" Value="@segment">@segment</MudSelectItem>
                                }
                            </MudSelect>
                            <MudSwitch @bind-Value="EnableSection5"
                                       Color="Color.Primary"
                                       Label="Enable Section 5"
                                       Class="mt-2" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

        </MudGrid>

        <MudGrid>
            <MudItem xs="12">
                <MudPaper Class="pa-4 mt-2">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               DisableElevation="true"
                               OnClick="SaveSettings"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Save">
                        Save Settings
                    </MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudForm>
</MudContainer>

<MudPaper Class="doc-section-component-container">
    <MudChart ChartType="ChartType.Bar" ChartSeries="@_series" @bind-SelectedIndex="_index" XAxisLabels="@_xAxisLabels" Width="@_width" Height="@_height" AxisChartOptions="_axisChartOptions"></MudChart>
</MudPaper>


@code {
    private int _index = -1; //default value cannot be 0 -> first selectedindex is 0.
    private string _width = "650px";
    private string _height = "350px";
    private AxisChartOptions _axisChartOptions = new AxisChartOptions();

    private List<ChartSeries> _series = new List<ChartSeries>()
    {
        new ChartSeries() { Name = "United States", Data = new double[] { 40, 20, 25, 27, 46, 60, 48, 80, 15 } },
        new ChartSeries() { Name = "Germany", Data = new double[] { 19, 24, 35, 13, 28, 15, 13, 16, 31 } },
        new ChartSeries() { Name = "Sweden", Data = new double[] { 8, 6, 11, 13, 4, 16, 10, 16, 18 } },
    };
    private string[] _xAxisLabels = { "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep" };

    MudForm form = default!;
    private int SmoothDuration { get; set; }
    private int HoldDuration { get; set; }
    private int SensorDelay { get; set; }
    private int Steps { get; set; }
    private int MaxBrightness { get; set; }
    private int MinBrightness { get; set; }
    private int ProximityEventTreshold { get; set; }

    private readonly int[] _segments = Enumerable.Range(0, 15).ToArray();
    private IEnumerable<int> Section1 { get; set; } = new HashSet<int>();
    private IEnumerable<int> Section2 { get; set; } = new HashSet<int>();
    private IEnumerable<int> Section3 { get; set; } = new HashSet<int>();
    private IEnumerable<int> Section4 { get; set; } = new HashSet<int>();
    private IEnumerable<int> Section5 { get; set; } = new HashSet<int>();
    private bool EnableSection3 { get; set; }
    private bool EnableSection4 { get; set; }
    private bool EnableSection5 { get; set; }

    protected override void OnInitialized()
    {
        LoadSettings();
        State.OnChange += OnStateChanged;
        SettingsService.SettingsChanged += OnSettingsChanged;
    }

    private void LoadSettings()
    {
        var settings = SettingsService.GetSettings();
        SmoothDuration = (int)settings.SmoothDuration.TotalMilliseconds;
        HoldDuration = (int)settings.HoldDuration.TotalMilliseconds;
        SensorDelay = (int)settings.SensorDelay.TotalMilliseconds;
        Steps = settings.Steps;
        MaxBrightness = settings.MaxBrightness;
        MinBrightness = settings.MinBrightness;
        ProximityEventTreshold = settings.ProximityEventTreshold;

        Section1 = settings.Section1.ToHashSet();
        Section2 = settings.Section2.ToHashSet();
        Section3 = settings.Section3.ToHashSet();
        Section4 = settings.Section4.ToHashSet();
        Section5 = settings.Section5.ToHashSet();

        EnableSection3 = settings.Section3 != null && settings.Section3.Count > 0;
        EnableSection4 = settings.Section4 != null && settings.Section4.Count > 0;
        EnableSection5 = settings.Section5 != null && settings.Section5.Count > 0;
    }

    private async void OnStateChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void OnSettingsChanged(object? sender, EventArgs e)
    {
        LoadSettings();
        await InvokeAsync(StateHasChanged);
    }

    private void SimulateSensor(Sensor sensor)
    {
        var settings = SettingsService.GetSettings();
        var rnd = Random.Shared.Next(55_000);
        var simulatedEvent = new ProximityEvent(sensor, settings.ProximityEventTreshold + rnd, DateTime.Now);

        // Trigger EventHandler also

        State.Update(simulatedEvent);
        Snackbar.Add($"Simulated {sensor} trigger!", Severity.Info);
    }

    private async Task SaveSettings()
    {
        await form.Validate();

        if (form.IsValid)
        {
            try
            {
                SettingsService.UpdateSettings(settings =>
                {
                    settings.SmoothDuration = TimeSpan.FromMilliseconds(SmoothDuration);
                    settings.HoldDuration = TimeSpan.FromMilliseconds(HoldDuration);
                    settings.SensorDelay = TimeSpan.FromMilliseconds(SensorDelay);
                    settings.Steps = Steps;
                    settings.MaxBrightness = MaxBrightness;
                    settings.MinBrightness = MinBrightness;
                    settings.ProximityEventTreshold = ProximityEventTreshold;
                    settings.Section1 = Section1.ToList();
                    settings.Section2 = Section2.ToList();
                    settings.Section3 = Section3.ToList();
                    settings.Section4 = Section4.ToList();
                    settings.Section5 = Section5.ToList();
                });

                Snackbar.Add("Settings saved successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error parsing sections: {ex.Message}", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("Please fix validation errors", Severity.Error);
        }
    }

    public void Dispose()
    {
        State.OnChange -= OnStateChanged;
        SettingsService.SettingsChanged -= OnSettingsChanged;
    }
}